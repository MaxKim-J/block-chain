# 블록 구현하기

## 블록 체인의 구조

- 크게 복잡할 건 없고 성장하는, 위상적으로 정렬된 원장을 가졌다는 특징을 가짐
- 여기서는 연결리스트 비슷한 블록체인 구현
- 블록 자체는 하나의 자료구조, 객체비슷한 것
  - 헤더 : 블록의 기본 정보와 데이터필드의 요약
  - 데이터 : 실제 저장하고자 하는 데이터
  - 버전 : 해당 블록을 생성한 블록체인 코어의 버전 정보 기록. p2p 네트워크에서는 동시에 서로 다른 버전의 프로토콜이 혼재할 수 있으므로 상호 식별을 위해 버전 필드 필요
  - 인덱스 : 높이
  - 이전 해시 : 이전 블록의 해시값. 인접한 블록에 대한 정보. 이전 블록의 헤더 내용으로부터 계산할 수 있음 **현재의 블록이 이전 블록의 해시값을 참조**
- 해시 함수 : 임의의 길이의 데이터를 입력받아 고정된 길이의 출력으로 매핑하는 함수. 해시 함수의 출력을 해시값 혹은 해시로 칭함. 블록체인에서 활용하는 해시 함수는 출력으로부터 입력을 추론하기 어려운 앟모학적 해시 함수(SHA-3, 입력이 1비트만 달라져도 출력이 크게 달라짐) 
- 타임스탬프 : 블록이 생성된 시점의 시간 정보. 유닉스 타임스탬프
- 머클 루트 : 데이터를 통해 만든 해시값을 또 해시에 돌리고 돌리는 방식으로 머클 트리라는 것을 만듬. 리프는 데이터고 위로 올라갈수록 데이터의 해시, 인접한 데이터와의 해시 등등으로 해시를 더 많이 돌리고 루트는 그 모든 해시를 모아 또 해시를 돌린 것
  - 검증자는 머클 루트만 알면 모든 데이터의 유효성을 검증할 수 있다. 일부 데이터가 위변조되면 이를 자식으로 포함하는 트리 경로의 값이 모두 변하므로 종국적으로 머클 루트의 이 달라짐. **모든 데이터의 요약**
  - 모든 데이터가 원래 그대로였다면 머클 루트의 해시값도 그대로(트리의 노드를 이루는 데이터와 해시를 모두 재해시하여 루트에 올려놓은 것이기 때문). 뭐가 하나 위변조되었다면 해쉬값이 달라질 것
- 머클 증명 : 몇개의 해시갑소가 머클 루트를 가지고 있다면 특정 데이터가 블록에 포함되어있는지를 검증할 수 있음. 특정 데이터의 해시 -> 인접 데이터와의 해시 계속 구해서 루트까지 올라감 -> 구한 해시값과 머클 루트의 값이 다르면 특정 데이터는 블록에 포함되어있지 않으므로 위변조가 있었음을 알 수 있음
- 데이터 필드에는 거래만이 아니라 어더한 데이터도 담을 수 있음. 
- 블록체인을 저장하는 방법은 다양함 데이터베이스, 인메모리 등등

## 블록 해시

- 작업 증명과 같은 합의 과정을 정하지 않았으므로, 블록 해시는 오직 무결성 검증과 다음 블록으로부터의 참조만을 담당한다.
- 해시 함수에서는 입력의 한 비트만 바뀌더라도 해시값이 크게 변하므로 만일 블록 내부의 정보가 조금이라도 바뀐다면 본래의 해시값이 유효하지 않게 된다. 따라서 블록 해시는 블록의 유일한 식별자로 취급
- 이전 해시가 블로그이 구성요소로 포함된 이상 블록을 임의로 위변조하기는 매우 힘든 일. 어느 한 블록이 정보를 변경하면 이후 연결된 모든 블로그이 해시값을 새로 계산해야 함(이거 성능 어쩔...) => 한 트랜잭션 마다 유니크한 블록 구조

## 제네시스 블록

- 블록체인의 첫번째 블록. 인덱스가 0인 블록. 연결리스트의 시작점
- 유일하게 이전 해시가 참조하는 블록이 없으므로 해당 필드의 값을 0x00000000 이렇게 둔다
- 블록체인 네트워크 참여자들은 공통된 제네시스 블록을 참조해야 한다. 따라서 제니시스 블록은 프로토콜상에 하드코딩돼있음

## 블록 생성

- 이전 블록의 해시값, 블록체인 코어의 버전 벙보, 인덱스, 타임스탬프, 데이터로부터 계산된 머클 루트가 필요(해쉬 결과)

## 블록 검증

- 어느 시점에서든 블록과 블록체인의 무결성 검증이 가능해야 함. 특히 나중에 네트워크에 연결되어 다른 노드로부터 블록을 전파받았을 때 수용 여부를 판단하는 것이 중요
- 블록 구조가 유효해야 하며, 현재 블록의 인덱스는 이전 블로그이 인덱스보다 정확히 1만큼 더 커야함. 이전 블록의 해시값과 현재 블록의 이전 해시가 같아야함. 데이터 필드로부터 계산한 머클 루트와 블록 헤더의 머클 루트가 동일해야함
- 블록 검증을 반복하는 것으로 블록 체인을 검증할 수 있음. 생성한 블록이 유효하다면 원장을 업데이트함